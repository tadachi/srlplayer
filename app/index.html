<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='content-type'>
    <title>srlplayer - lists popular gaming streams in a tabular format with built-in chat.</title>
    <meta name='description' content='Twitch stream viewer specifically for speedrunslive streamers <3. http://srl.takbytes.com'>
    <meta name='keywords' content='srlplayer takbytes.com SRL speedrunslive speedrunslive streamer speedrunslivestreamer srlstreamer srlplayer'>
    <meta name='author' content='takada'>
    <link rel='stylesheet' href='css/main.css'>

    <script src='js/jquery-2.1.1.min.js'></script>
    <!--<script src='js/jquery-2.0.3.min.js'></script>-->
    <script src='js/jquery.typing-0.2.0.min.js'></script>
    <script src='js/async.min.js'></script>
    <!--<script src='js/simple-storage.min.js'></script>-->

    <script>
    /*
     * Similar to what you find in Java's format.
     * Usage: chatsrc = 'http://twitch.tv/chat/embed?channel={channel}&amp;popout_chat=true'.format({ channel: streamer});
     */
    if (!String.prototype.format) {
        String.prototype.format = function() {
            var str = this.toString();
            if (!arguments.length)
                return str;
            var args = typeof arguments[0],
                args = (('string' == args || 'number' == args) ? arguments : arguments[0]);
            for (arg in args)
                str = str.replace(RegExp('\\{' + arg + '\\}', 'gi'), args[arg]);
            return str;
        }
    }

    /*
     * Example usage:
     *   "http://dummy.com/?technology=jquery&blog=jquerybyexample".
     *   var tech = getQueryStringParams('technology');
     *   var blog = getQueryStringParams('blog');
     */
     function getQueryStringParams(sParam) {
        console.log(sParam);

        var sPageURL      = window.location.href;
        var sURLVariables = sPageURL.split('/');
        var querystring;
        var count         = 0;
        var key;
        var value;

        for (i = 0; i < sURLVariables.length; i++) {
            if (sURLVariables[i].substring(0, 1) == '?') { // Found query string.
                querystring = sURLVariables[i].substring(1).split('&');
            }
        }

        if (querystring) {
            for (i = 0; i < querystring.length; i++) {
                arr = querystring[i].split('=');
                key = arr[0];
                value = arr[1];
                if (key == sParam) { // key mataches param.
                    return value;    // Return match.
                }
            }
        }

        return null;
     }

    /*
     * Ajax calls speedrunslive api and grabs json. Loads the json to a div through srlAndFollowedStreamTable().
     * Also can load followed streams that are online.
     */
    function loadStreams() {
        //'http://api.speedrunslive.com/test/team'      <--- LIVE DATA
        //'test/srlJson.json'                           <--- TEST DATA // Use this instead of hammering speedrunslive server.
        twitchusername = '';
        if (localStorage.getItem('twitchusername')) {
            twitchusername = localStorage.getItem('twitchusername')
        }

        // async.parallel will run all tasks at the same time.

        async.parallel([
            function (callback) {
                getAllFollowedStreams(twitchusername, function(results) {
                    callback(null, results);
                });
            },
            function (callback) {
                $.ajax({
                    url: 'http://api.speedrunslive.com/test/team',

                    // the name of the callback parameter, as specified by the YQL service
                    jsonp: 'callback',

                    // tell jQuery we're expecting JSONP
                    dataType: 'jsonp', // Use JSONP. Workaround for Access-Control-Allow-Origin header.

                    // work with the response
                    success: function( srlJson ) {
                        // console.log( response ); // server response
                        callback(null, srlJson);
                    }
                });
            }
        ],
        function(err, streams) { // Each task will push their callbacks into an array.
            // console.log(streams);
            srlAndFollowedStreamTable(streams);
        });

    }

    /*
     * Loads the json to a div through srlAndFollowedStreamTable(). Does most of the work.
     */
    function srlAndFollowedStreamTable(streams) {
        var html = '';
        var length = 0;

        if (streams[0]) {
            for (i = 0; i < streams[0].length; i++) {
                if (streams[0][i]) { //Ignore null streams(offline) and add only streams that are online.
                    stream = streams[0][i].stream;

                    html += buildStreamSelectorHTML(stream.channel.name, stream.channel.logo, stream.channel.status, stream.viewers, true); // Build the html string with online streams.
                }
            }
        }

        for (i = 0; i < streams[1].channels.length; i++ ) { // Populates the streams from a json file from speedrunslive.com.
            channel = streams[1].channels[i].channel; // streamer's channel unique name.

            html += buildStreamSelectorHTML(channel.display_name, channel.image.size70, channel.title, channel.current_viewers, false); // Append html string with SRL streams.
        }

        $('#streams ul').html(html); // Apply the combined html to this tag.

        //This allows fast switching of streams by changing the param in the videoplayer object,
        $('#streams ul li').click( function(e) {
            if( e.which == 2 ) { //prevent middle click
                e.preventDefault();
            }
            data = $(this).text().split(' '); // Parse html with twitch name. data[0] or first item is the channel name. the rest of array not needed.
            console.log(data[0]);
            // Reinject the videoplayer with the new params pointing to the chosen stream.
            reloadVideoPlayer(data[0]);
            // Reinject the chat with the new params pointing to the chosen stream.
            reloadChatBox(data[0]);
        });


        function buildStreamSelectorHTML(streamer_name, image, title, current_viewers, followed) {
            if (followed) {
                opentag = '<a href=\'#!/?streamer={streamer}\'><li class=\'followed\'>'.format({streamer: streamer_name});;
                streamer_name = '<span style=\'font-size:140%; color:green; font-weight:bold;\'>{name}</span>'.format({name: streamer_name});
            }
            else if (i%2) { //Make even and uneven different colors.
                opentag = '<a href=\'#!/?streamer={streamer}\'><li class=\'odd\'>'.format({streamer: streamer_name});;
                streamer_name = '<span class=\'oddtitle\'>{name}</span>'.format({name: streamer_name});
            } else {
                opentag = '<a href=\'#!/?streamer={streamer}\'><li class=\'even\'>'.format({streamer: streamer_name});
                streamer_name = '<span class=\'eventitle\'>{streamer}</span>'.format({streamer: streamer_name});
            }

            image          = '<img width=60 height=60 align=\'left\' src=\'{logo}\' alt=min>'.format({logo: image}); // Streamer's logo

            currentviewers = '<span style=\'color: red;\'>{viewercount}</span>'.format({viewercount: current_viewers}); // Number of viewers.

            endtag = '</li></a>'

            html = '{opentag}{image}{name} {viewers} - {title} {endtag}'.format({
                        opentag : opentag,
                        image   : image,
                        name    : streamer_name,
                        title   : title,
                        viewers : currentviewers,
                        endtag  : endtag
                        });
            return html;
        }
    }

    /*
     * Searches Those you follow that are online.
     */
    function getAllFollowedStreams(name, callback) {
        var asyncTasks = [];
        var offset     = 0; // get the next 25 people if you follow more than 25 people so increase offset by 25.
        var limit      = 100;
        $.ajax({
            url: 'https://api.twitch.tv/kraken/users/{name}/follows/channels?direction=DESC&limit={limit}&offset={offset}&sortby=created_at'.format({ name: name, limit: limit, offset: offset }),
            jsonp: 'callback',
            dataType: 'jsonp', // tell jQuery we're expecting JSONP.

            success: function(streams) {
                if(streams.follows) {
                    getOnlyOnlineFollowed(streams, function(results) {
                        callback( results );
                    });
                }else{
                    callback(null);
                }
            }
        });
    }

    /*
     * Returns an array of streams that are online.
     * See https://github.com/caolan/async for more details on async.js.
     */
    function getOnlyOnlineFollowed(streams, callback) {
        var asyncTasks = [];

        // Array of streams to see if online.
        streams.follows.forEach(function(stream) {
                asyncTasks.push(
                    function(callback) {
                        isStreamOnline(stream.channel.name, function(results) {
                            callback(null, results);
                        });
                    }
                );
        });

        // async.parallel will run all tasks at the same time.
        async.parallel( asyncTasks,
        function(err, results) { // Each task will push their callbacks into an array.
            callback(results);
        });
    }

    /*
     * Will check if stream is online.
     * see https://github.com/justintv/Twitch-API/blob/master/v3_resources/streams.md
     */
    function isStreamOnline(streamname, callback) {
        $.ajax({
            url: 'https://api.twitch.tv/kraken/streams/' + streamname,

            jsonp: 'callback',

            dataType: 'jsonp', // tell jQuery we're expecting JSONP.

            success: function( stream ) { // work with the response.
                //console.log(stream);
                if (stream.stream) {
                    callback(stream);
                }else {
                    callback(null);
                }
            }
        });
    }

    /* Reinjects HTML with the twitch embed pointing to the stream. */
    function reloadVideoPlayer(streamername) {
        res = calcResolutions();

        // Create the channel string based on chosen stream.
        flashvars = 'channel={CHANNEL}&auto_play=true'.format({
            CHANNEL: streamername});

        html =    ["<object bgcolor='#000000'",
                        "data='http://www.twitch.tv/widgets/archive_embed_player.swf'",
                        "id='videoplayerembed'",
                        "type='application/x-shockwave-flash'",
                        "width='{w}'".format({ w: res.centerW }),
                        "height='{h}'>".format({ h: res.centerH }),
                        "<param name='movie' value='http://www.twitch.tv/widgets/archive_embed_player.swf' />",
                        "<param name='allowScriptAccess' value='always' />",
                        "<param name='allowNetworking' value='all' />",
                        "<param name='allowFullScreen' value='true' />",
                        "<param name='flashvars' value='{flashvars}'/>".format({flashvars: flashvars}),
                    "</object>"
                    ].join('');

        $('#videoplayer').html(html);
    }

    /*
     * Reinjects HTML with the twitch chat embed pointing to the stream.
     */
    function reloadChatBox(streamername) {
        res = calcResolutions();

        // Change the chat to the corresponding video channel.
        src = 'http://twitch.tv/chat/embed?channel={ch}&amp;popout_chat=true'.format({
            ch: streamername});

        if (leftShow && !rightShow) { //Right is hidden so expand the videoplayer.
            $('#right').toggle();
            rightShow = !rightShow;
            $('#toggleright').toggleClass('flaticon-right39 flaticon-arrowheads3');
        }

        html =    ['<iframe ',
                        'id=\'chat_embed\' ',
                        'frameborder=\'0\' ',
                        'scrolling=\'yes\' ',
                        'src=\'{src}\' '.format({src: src}),
                        'width=\'{w}\' '.format({w: res.rightW}),
                        'height=\'{h}\'>'.format({h: res.rightH}),
                    '</iframe>'].join('');

        $('#chatbox').html(html);
    }



    /*
     * Creates and returns an object that has resolutions for 3 panels. left, center and right.
     */
    function calcResolutions() {
        hOffset               = 26; //Height for our header
        currWinWidth          = $(window).width();
        currWinHeight         = $(window).height();

        headerPanelWidth      = Math.floor(currWinWidth);
        headerPanelHeight     = Math.floor(hOffset);

        containerWidth        = (currWinWidth);
        containerHeight       = (currWinHeight);

        leftPanelWidth        = Math.ceil( (0.14 * currWinWidth) );
        leftPanelHeight       = Math.floor(currWinHeight - hOffset);

        settingsMenuWidth     = Math.ceil(0.14 * currWinWidth);
        settingsMenuHeight    = Math.floor(500);

        rightPanelWidth       = Math.floor( (0.18 * currWinWidth) );
        rightPanelHeight      = Math.floor(currWinHeight - hOffset);

        centerPanelWidth      = Math.floor( (0.68 * currWinWidth) );
        centerPanelHeight     = Math.floor(currWinHeight - hOffset);
        console.log(centerPanelWidth);
        leftPlusCenterWidth   = Math.ceil(0.82 * currWinWidth);
        leftPlusCenterHeight  = Math.floor(currWinHeight - hOffset);
        rightPlusCenterWidth  = Math.floor(0.86 * currWinWidth);
        rightPlusCenterHeight = Math.floor(currWinHeight - hOffset);
        centerOnlyWidth       = Math.floor(currWinWidth);
        centerOnlyHeight      = Math.floor(currWinHeight - hOffset);

        return {
                containerW: containerWidth, containerH: containerHeight,
                headerW: headerPanelWidth, headerH: headerPanelHeight,
                leftW: leftPanelWidth, leftH: leftPanelHeight,
                rightW: rightPanelWidth, rightH: rightPanelHeight,
                centerW: centerPanelWidth, centerH: centerPanelHeight,
                leftCenterW: leftPlusCenterWidth, leftCenterH: leftPlusCenterHeight,
                rightCenterW: rightPlusCenterWidth, rightCenterH: rightPlusCenterHeight,
                centerOnlyW: centerOnlyWidth, centerOnlyH: centerOnlyHeight,
                settingMenuW: settingsMenuWidth, settingsMenuH: settingsMenuHeight
                };

    }

    function limitTo(limit, current) {
        if (current <= limit) {
            //console.log(limit);
            return limit;
        }
        return current;
    }

    /*
     * Apply panel resolutions based on current window sizes to various divs
     */
    function applyResolutions() {
        res = calcResolutions();

        verticalScrollbarWidth = 17;

        $('#container').css('width', res.containerW);
        $('#container').css('height', res.containerH);

        $('#header').css('width',res.headerW);
        $('#header').css('height',res.headerH);

        // $('#left ul').css('width', res.leftW - verticalScrollbarWidth);
        // $('#left ul li').css('width', res.leftW - verticalScrollbarWidth);

        $('#settingsmenu').css('width', res.leftW);
        $('#settingsmenu').css('height', 500);
        $('#settingsmenu').css('margin-top', headerPanelHeight);

        if (leftShow) {
            $('#left').css('width', res.leftW);
            $('#left').css('height', res.leftH);
        }
        if (rightShow) {
            $('#right').css('width', res.rightW);
            $('#right').css('height', res.rightH);
        }
        if (!leftShow && rightShow) {
            $('#center').css('width', res.leftCenterW);
            $('#center').css('height', res.leftCenterH);
            $('#videoplayerembed').css('width', res.leftCenterW);
            $('#videoplayerembed').css('height', res.leftCenterH);
        }else if (leftShow && !rightShow) {
            $('#center').css('width', res.rightCenterW);
            $('#center').css('height', res.rightCenterH);
            $('#videoplayerembed').css('width', res.rightCenterW);
            $('#videoplayerembed').css('height', res.rightCenterH);
        }else if ( (!leftShow && !rightShow) ) {
            $('#center').css('width', res.centerOnlyW);
            $('#center').css('height', res.centerOnlyH);
            $('#videoplayerembed').css('width', res.centerOnlyW);
            $('#videoplayerembed').css('height', res.centerOnlyH);
        }else if (leftShow && !rightShow) {
            $('#center').css('width', res.rightCenterW);
            $('#center').css('height', res.rightCenterH);
            $('#videoplayerembed').css('width', res.rightCenterW);
            $('#videoplayerembed').css('height', res.rightCenterH);
        }else {
            $('#center').css('width', res.centerW);
            $('#center').css('height', res.centerH);
            $('#videoplayerembed').css('width', res.centerW);
            $('#videoplayerembed').css('height', res.centerH);
        }

        $('#chat_embed').css('width', res.rightW);
        $('#chat_embed').css('height', res.rightH);

        /* Header */
        $('#toggleright').css('margin-left', res.headerW-47); //Align image to far right properly.
        $('#settings').css('margin-left', res.leftW -215);
        $('#refreshstreams').css('margin-left', res.leftW-42);
        $('#copyright').css('margin-left', res.headerW-180); //Align to far right properly.
        $('#multitwitchchat').css('margin-left', res.leftW); //Align after refresh stream properly.
    }

    function toggleLeft() {
        $('#left').toggle(); // Toggle show/hide
        leftShow = !leftShow; // Toggle the boolean.
        $('#toggleleft').toggleClass('flaticon-arrowheads3 flaticon-right39'); //Toggle where the icon points to.

        if (!leftShow && rightShow) { //Left is hidden so expand the videoplayer.
            $('#center').css('width', res.leftCenterW);
            $('#center').css('height', res.leftCenterH);
            $('#videoplayerembed').css('width', res.leftCenterW);
            $('#videoplayerembed').css('height', res.leftCenterH);
        }
        if ( (!leftShow && !rightShow) ) { //Both left and right are hidden so maximize videoplayer.
            $('#center').css('width', res.centerOnlyW);
            $('#center').css('height', res.centerOnlyH);
            $('#videoplayerembed').css('width', res.centerOnlyW);
            $('#videoplayerembed').css('height', res.centerOnlyH);
        }
        if (leftShow && !rightShow) { //Right is hidden so expand the videoplayer.
            $('#center').css('width', res.rightCenterW);
            $('#center').css('height', res.rightCenterH);
            $('#videoplayerembed').css('width', res.rightCenterW);
            $('#videoplayerembed').css('height', res.rightCenterH);
        }
        if ( leftShow && rightShow) {
            applyResolutions();
        }
    }

    function toggleRight() {
        $('#right').toggle();
        rightShow = !rightShow;
        $('#toggleright').toggleClass('flaticon-right39 flaticon-arrowheads3');

        if (leftShow && !rightShow) { //Right is hidden so expand the videoplayer.
            $('#center').css('width', res.rightCenterW);
            $('#center').css('height', res.rightCenterH);
            $('#videoplayerembed').css('width', res.rightCenterW);
            $('#videoplayerembed').css('height', res.rightCenterH);
        }
        if ( (!leftShow && !rightShow) ) { //Both left and right are hidden so maximize videoplayer.
            $('#center').css('width', res.centerOnlyW);
            $('#center').css('height', res.centerOnlyH);
            $('#videoplayerembed').css('width', res.centerOnlyW);
            $('#videoplayerembed').css('height', res.centerOnlyH);
        }
        if (!leftShow && rightShow) { //Left is hidden so expand the videoplayer.
            $('#center').css('width', res.leftCenterW);
            $('#center').css('height', res.leftCenterH);
            $('#videoplayerembed').css('width', res.leftCenterW);
            $('#videoplayerembed').css('height', res.leftCenterH);
        }
        if (leftShow && rightShow) {
            applyResolutions();
        }
    }

    var leftShow = true;
    var rightShow = true;

    /* Main */
    $( document ).ready(function() {

        /* Load stream from url querystring */
        var streamer = getQueryStringParams('streamer');

        if(streamer) {
            reloadVideoPlayer(streamer);
            reloadChatBox(streamer);
        }

        loadStreams();

        applyResolutions(); // Apply panel resolutions based on current window sizes

        $('#toggleleft').click(function(event) {
            toggleLeft();
        });

        $('#toggleright').click(function(event) {
            toggleRight();
        });

        $('#refreshstreams').click(function() {
            loadStreams();
        });

        $('#settings').click(function() {
            $('#settingsmenu').toggle();
        })

        setInterval(function() {
            loadStreams();
        }, 180000); // Refresh live channels every 3 minutes

        /*** Manage settings with session/localstorage ***/
        if( localStorage.getItem('twitchusername') ) {
            $('#twitchusername').val(localStorage.getItem('twitchusername'));
            $('#showfollowedstreams').prop('checked', true); // Checkbox is checked.
            $("#twitchusername").prop('disabled',true); // Disable textbox.
        }

        $('#showfollowedstreams').click(function() { // Toggle show followers on list of streamers.
            if ($(this).is(':checked')) {
                localStorage.setItem('twitchusername', $('#twitchusername').val());
                $("#twitchusername").prop('disabled',true); // Disable textbox.
            }else {
                $("#twitchusername").prop('disabled',false); // Enable textbox.
                localStorage.removeItem('twitchusername');
            }
        });

        $('#apply').click(function() {
            location.reload();
        });

    });

    $( window ).resize(function() {
        applyResolutions();
    });
    </script>

    </head>
    <body>
        <div id='container'>
            <div id='settingsmenu'>
                <div style='position: relative; border: 1px solid;'>
                    <input id='showfollowedstreams' type='checkbox'>Enable show followed streams. Enter twitch username only:
                    <input id='twitchusername' type='text' value=''></input>
                </div>
                <button id='apply' style='float: right; margin-top: 20px;' >Apply</button>
            </div>

            <div id='header' class='unselectable'>
                <div id='toggleleft' style='position: relative; display:inline-block; margin: 0px 0px 0px 0px; cursor: pointer;' class='glyph flaticon-right39'></div>

                <div id='settings' class='senlightfont unselectable' style='position: absolute; display:inline-block; cursor: pointer; margin-top: 1px; padding: 1px 10px 1px 10px; font-size: medium;
                    border-radius: 4px; border-color: black; border: 1px solid; background-color: white; cursor: pointer;'>Settings</div>

                <div id='copyright' class='senlightfont' style='position: absolute; display:inline-block; margin: 3px 0px 0px 0px; font-size: medium;'>&copy; 2014 takada</div>

                <div id='refreshstreams' style='position: absolute; display:inline-block; margin: 0px 0px 0px 0px; cursor: pointer;' class='glyph-icon flaticon-two123'></div>

                <span id='multitwitchchat' class='senlightfont unselectable' style='position: absolute; display:inline-block; margin: 3px 0px 0px 0px;'><a href='http://mtc.takbytes.com'>multitwitchchat</a></span>

                <div id='toggleright' style='position: absolute; cursor: pointer; display:inline-block; margin: 0px 0px 0px 0px;' class='glyph flaticon-arrowheads3'></div>
            </div>

            <div id='left'>
                <div id='streams'>
                    <ul></ul>
                </div>
            </div>

            <div id='center'>
                <div id='videoplayer'>
                </div>
            </div>

            <div id='right'>
                <div id='chatbox'>
                </div>
            </div>

        </div>

    </body>
</html>
