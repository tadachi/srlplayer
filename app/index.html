<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='content-type'>
    <title>srlplayer</title>
    <meta name="description" content="Twitch stream viewer specifically for speedrunslive streamers <3. http://srl.takbytes.com">
    <meta name='keywords' content='srlplayer takbytes.com SRL speedrunslive speedrunslive streamer speedrunslivestreamer srlstreamer srlplayer'>
    <meta name='author' content='takada'>
    <link rel='stylesheet' href='css/main.css'>

    <script src='js/jquery-2.1.1.min.js'></script>
<!--     <script src='js/twitch.min.js'></script> -->
    <script>
    if (typeof jQuery != 'undefined') {
        // jQuery is loaded => print the version
        console.log(jQuery.fn.jquery);
    }

    /* Similar to what you find in Java's format. */
    /* Usage: chatsrc = 'http://twitch.tv/chat/embed?channel={channel}&amp;popout_chat=true'.format({ channel: streamer}); */
    if (!String.prototype.format) {
        String.prototype.format = function() {
            var str = this.toString();
            if (!arguments.length)
                return str;
            var args = typeof arguments[0],
                args = (('string' == args || 'number' == args) ? arguments : arguments[0]);
            for (arg in args)
                str = str.replace(RegExp('\\{' + arg + '\\}', 'gi'), args[arg]);
            return str;
        }
    }

    /*
     * Ajax calls speedrunslive api and grabs json. Loads the json to a div through srlTeamChannelTable().
     */
    function loadSrlTeamChannels() { //Check for Memory Leaks. 06/02/2014 Memory leaks came from Adobe's flash. Use Chrome's pepper flash for stability.
        // This uses JSON. Note: this method does not work anymore due to CORS ( grab cross-domain resources forbidden)
//         $.getJSON('http://api.speedrunslive.com/test/teamcallback=?',function(json){
//             console.log(json);
//             srlTeamChannelTable(json);
//         });

        //'http://api.speedrunslive.com/test/team'      <--- LIVE DATA
        //'test/srlJson.json'                           <--- TEST DATA // Use this instead of hammering speedrunslive server.

        // Uses JSONP. Workaround for Access-Control-Allow-Origin header.
        $.ajax({
            url: "http://api.speedrunslive.com/test/team",

            // the name of the callback parameter, as specified by the YQL service
            jsonp: "callback",

            // tell jQuery we're expecting JSONP
            dataType: "jsonp",

            // work with the response
            success: function( response ) {
                console.log( response ); // server response
                srlTeamChannelTable(response);
            }
        });
    }

    /*
     * Loads the json to a div through srlTeamChannelTable(). Does most of the work.
     */
    function srlTeamChannelTable(srlJson) {
        var html = '';
        var length = 0;

        /* get the number of current live channels from speedrunslive api json file.*/
        for (key in srlJson.channels) {
            length++;
        }


        for (var i = 0; i < length; i++ ) { // Populates the streams from a json file from speedrunslive.com.

            channel = srlJson.channels[i].channel; // streamer's channel unique name.

            image = '<img width=60 height=60 align=\'left\' src=\' ' + // Streamer's logo
                channel.image.size70 + '\' alt=min>';

            currentviewers = '<span style=\'color: red;\'>' + channel.current_viewers + '</span>'; // Number of viewers.

            if (i%2) { //Make even and uneven different colors.
                list1 = '<li class=\'odd\' value={n}>'.format({n: i})
                streamername = '<span style=\'font-size:140%; color:lightgreen; font-weight:bold;\'>' + channel.display_name + '</span>';
            } else {
                list1 = '<li class=\'even\' value={n}>'.format({n: i});
                streamername = '<span style=\'font-size:140%; color:green; font-weight:bold;\'>' + channel.display_name + '</span>';
            }

            html +=  '{opentag}{img1}{name} {viewers} - {title} {endtag}'.format({
            opentag: list1,
            img1: image,
            name: streamername,
            title: channel.title,
            viewers: currentviewers,
            endtag: '</li>'
            });
        }

        $('#streams ul').html(html); // Apply the html to this tag.

        //This allows fast switching of streams by changing the param in the videoplayer object,
        $('#streams ul li').click( function() {
            data = $(this).text().split(' '); // data[0] or first item is the channel name. the rest of array not needed.

            // Create the channel string based on chosen stream.
            flashvars = 'channel={CHANNEL}&auto_play=true'.format({
                CHANNEL: data[0]});

            // Change the video channel via DOM
            $('#videoplayer_embed param[name=flashvars]').attr('value', flashvars );

            // Reinject the videoplayer with the new params pointing to the chosen stream.
            reloadVideoPlayer(flashvars);

            // Change the chat to the corresponding video channel.
            chatsrc = 'http://twitch.tv/chat/embed?channel={ch}&amp;popout_chat=true'.format({
                ch: data[0]});

            //$('#chat_embed').prop('src', chatsrc);     // this is Faster does not work in IE.
            reloadChatBox(chatsrc);                      // reinjects iframes. Slightly slower. Does not work in IE either.
        });
    }

    /* Reinjects HTML with the twitch embed pointing to the stream. */
    function reloadVideoPlayer(streamer) {
        res = calcResolutions();

        player = $('#videoplayer');

        html =    ["<object bgcolor='#000000'",
                        "data='http://www.twitch.tv/widgets/archive_embed_player.swf'",
                        "id='videoplayer_embed'",
                        "type='application/x-shockwave-flash'",
                        "width='{w}'".format({ w: res.centerW }),
                        "height='{h}'>".format({ h: res.centerH }),
                        "<param name='movie' value='http://www.twitch.tv/widgets/archive_embed_player.swf' />",
                        "<param name='allowScriptAccess' value='always' />",
                        "<param name='allowNetworking' value='all' />",
                        "<param name='allowFullScreen' value='true' />",
                        "<param name='flashvars' value='{flashvars}'/>".format({flashvars: streamer}),
                    "</object>"
                    ].join('');

        player.html(html);
    }

    /* Reinjects HTML with the twitch chat embed pointing to the stream. */
    function reloadChatBox(src) {
        res = calcResolutions();

        console.log(rightShow);
        if (leftShow && !rightShow) { //Right is hidden so expand the videoplayer.
            $('#right').toggle();
            rightShow = !rightShow;
            $('#toggle_right').toggleClass('flaticon-right39 flaticon-arrowheads3');
        }

        chatbox = $('#chatbox');

        html =    ['<iframe ',
                        'id=\'chat_embed\' ',
                        'frameborder=\'0\' ',
                        'scrolling=\'yes\' ',
                        'src=\'{url}\' '.format({url: src}),
                        'width=\'{w}\' '.format({w: res.rightW}),
                        'height=\'{h}\'>'.format({h: res.rightH}),
                    '</iframe>'].join('');

        applyResolutions();

        chatbox.html(html);


    }

    /*
     * Creates and returns an object that has resolutions for 3 panels. left, center and right.
     */
    function calcResolutions() {
        hOffset = 26; //Height for our header
        currWinWidth = $(window).width();
        currWinHeight = $(window).height();

        headerPanelWidth = Math.floor(currWinWidth);
        headerPanelHeight = Math.floor(hOffset);

        containerWidth = (currWinWidth);
        containerHeight = (currWinHeight);

        leftPanelWidth = Math.ceil(0.14 * currWinWidth);
        leftPanelHeight = Math.floor(currWinHeight - hOffset);

        rightPanelWidth = Math.floor(0.18 * currWinWidth);
        rightPanelHeight = Math.floor(currWinHeight - hOffset);

        centerPanelWidth = Math.floor(0.68 * currWinWidth);
        centerPanelHeight = Math.floor(currWinHeight - hOffset);

        leftPlusCenterWidth = Math.floor(0.82 * currWinWidth);
        leftPlusCenterHeight = Math.floor(currWinHeight - hOffset);
        rightPlusCenterWidth = Math.floor(0.86 * currWinWidth);
        rightPlusCenterHeight = Math.floor(currWinHeight - hOffset);
        centerOnlyWidth = Math.floor(currWinWidth);
        centerOnlyHeight = Math.floor(currWinHeight - hOffset);

        return {
                containerW: containerWidth, containerH: containerHeight,
                headerW: headerPanelWidth, headerH: headerPanelHeight,
                leftW: leftPanelWidth, leftH: leftPanelHeight,
                rightW: rightPanelWidth, rightH: rightPanelHeight,
                centerW: centerPanelWidth, centerH: centerPanelHeight,
                leftCenterW: leftPlusCenterWidth, leftCenterH: leftPlusCenterHeight,
                rightCenterW: rightPlusCenterWidth, rightCenterH: rightPlusCenterHeight,
                centerOnlyW: centerOnlyWidth, centerOnlyH: centerOnlyHeight
                };

    }

    /*
     * Apply panel resolutions based on current window sizes to various divs
     */
    function applyResolutions() {
        res = calcResolutions();
        verticalScrollbarWidth = 17;

        $('#container').css('width', res.containerW);
        $('#container').css('height', res.containerH);

        $('#header').css('width',res.headerW);
        $('#header').css('height',res.headerH);

        $('#left ul').css('width', res.leftW - verticalScrollbarWidth);
        $('#left ul li').css('width', res.leftW - verticalScrollbarWidth);

        if (leftShow) {
            $('#left').css('width', res.leftW);
            $('#left').css('height', res.leftH);
        }
        if (rightShow) {
            $('#right').css('width', res.rightW);
            $('#right').css('height', res.rightH);
        }
        if (!leftShow && rightShow) {
            $('#center').css('width', res.leftCenterW);
            $('#center').css('height', res.leftCenterH);
            $('#videoplayer_embed').css('width', res.leftCenterW);
            $('#videoplayer_embed').css('height', res.leftCenterH);
        }else if (leftShow && !rightShow) {
            $('#center').css('width', res.rightCenterW);
            $('#center').css('height', res.rightCenterH);
            $('#videoplayer_embed').css('width', res.rightCenterW);
            $('#videoplayer_embed').css('height', res.rightCenterH);
        }else if ( (!leftShow && !rightShow) ) {
            $('#center').css('width', res.centerOnlyW);
            $('#center').css('height', res.centerOnlyH);
            $('#videoplayer_embed').css('width', res.centerOnlyW);
            $('#videoplayer_embed').css('height', res.centerOnlyH);
        }else if (leftShow && !rightShow) {
            $('#center').css('width', res.rightCenterW);
            $('#center').css('height', res.rightCenterH);
            $('#videoplayer_embed').css('width', res.rightCenterW);
            $('#videoplayer_embed').css('height', res.rightCenterH);
        }else {
            $('#center').css('width', res.centerW);
            $('#center').css('height', res.centerH);
            $('#videoplayer_embed').css('width', res.centerW);
            $('#videoplayer_embed').css('height', res.centerH);
        }

        $('#chat_embed').css('width', res.rightW);
        $('#chat_embed').css('height', res.rightH);

        /* Header */
        $('#toggle_right').css('margin-left', res.headerW-47); //Align image to far right properly.
        $('#refresh_streams').css('margin-left', res.leftW-42);
        $('#copyright').css('margin-left', res.headerW-180); //Align to far right properly.
        $('#multitwitchchat').css('margin-left', res.leftW); //Align after refresh stream properly.
    }

    function toggleLeft() {
        $('#left').toggle(); // Toggle show/hide
        leftShow = !leftShow; // Toggle the boolean.
        $('#toggle_left').toggleClass('flaticon-arrowheads3 flaticon-right39'); //Toggle where the icon points to.

        if (!leftShow && rightShow) { //Left is hidden so expand the videoplayer.
            $('#center').css('width', res.leftCenterW);
            $('#center').css('height', res.leftCenterH);
            $('#videoplayer_embed').css('width', res.leftCenterW);
            $('#videoplayer_embed').css('height', res.leftCenterH);
        }
        if ( (!leftShow && !rightShow) ) { //Both left and right are hidden so maximize videoplayer.
            $('#center').css('width', res.centerOnlyW);
            $('#center').css('height', res.centerOnlyH);
            $('#videoplayer_embed').css('width', res.centerOnlyW);
            $('#videoplayer_embed').css('height', res.centerOnlyH);
        }
        if (leftShow && !rightShow) { //Right is hidden so expand the videoplayer.
            $('#center').css('width', res.rightCenterW);
            $('#center').css('height', res.rightCenterH);
            $('#videoplayer_embed').css('width', res.rightCenterW);
            $('#videoplayer_embed').css('height', res.rightCenterH);
        }
        if ( leftShow && rightShow) {
            applyResolutions();
        }
    }

    function toggleRight() {
        $('#right').toggle();
        rightShow = !rightShow;
        $('#toggle_right').toggleClass('flaticon-right39 flaticon-arrowheads3');

        if (leftShow && !rightShow) { //Right is hidden so expand the videoplayer.
            $('#center').css('width', res.rightCenterW);
            $('#center').css('height', res.rightCenterH);
            $('#videoplayer_embed').css('width', res.rightCenterW);
            $('#videoplayer_embed').css('height', res.rightCenterH);
        }
        if ( (!leftShow && !rightShow) ) { //Both left and right are hidden so maximize videoplayer.
            $('#center').css('width', res.centerOnlyW);
            $('#center').css('height', res.centerOnlyH);
            $('#videoplayer_embed').css('width', res.centerOnlyW);
            $('#videoplayer_embed').css('height', res.centerOnlyH);
        }
        if (!leftShow && rightShow) { //Left is hidden so expand the videoplayer.
            $('#center').css('width', res.leftCenterW);
            $('#center').css('height', res.leftCenterH);
            $('#videoplayer_embed').css('width', res.leftCenterW);
            $('#videoplayer_embed').css('height', res.leftCenterH);
        }
        if (leftShow && rightShow) {
            applyResolutions();
        }
    }

    var leftShow = true;
    var rightShow = true;

    /* Main */
    $( document ).ready(function() {
        loadSrlTeamChannels();

        applyResolutions(); // Apply panel resolutions based on current window sizes

        $('#toggle_left').click(function(event) {
            toggleLeft();
        });

        $('#toggle_right').click(function(event) {
            toggleRight();
        });

        $('#refresh_streams').click(function() {
            loadSrlTeamChannels();
        });

        setInterval(function() {
            loadSrlTeamChannels();
        }, 180000); // Refresh live channels every 3 minutes

    });

    $( window ).resize(function() {
        applyResolutions();
    });
    </script>

    </head>
    <body>
        <div id='container'>
            <div id='header' class='unselectable'>
                <div id='toggle_left' style='position: relative; display:inline-block; margin: 0px 0px 0px 0px; cursor: pointer;' class="glyph flaticon-right39"></div>

                <div id='copyright' class='senlightfont' style='position: absolute; display:inline-block; margin: 3px 0px 0px 0px; font-size: medium;'>&copy; 2014 takada</div>

                <div id='refresh_streams' style='position: absolute; display:inline-block; margin: 0px 0px 0px 0px; cursor: pointer;' class="glyph-icon flaticon-two123"></div>

                <span id='multitwitchchat' class='senlightfont' style='position: absolute; display:inline-block; margin: 3px 0px 0px 0px;'><a href='http://mtc.takbytes.com'>multitwitchchat</a></span>

                <div id='toggle_right' style='position: absolute; cursor: pointer; display:inline-block; margin: 0px 0px 0px 0px;' class="glyph flaticon-arrowheads3"></div>
            </div>

            <div id='left'>
                <div id='streams'>
                    <ul></ul>
                </div>
            </div>

            <div id='center'>
                <div id='videoplayer'>
                </div>
            </div>

            <div id='right'>
                <div id='chatbox'>
                <!-- Uncomment this iframe if you intend to debug chat -->
<!--                    <iframe id='chat_embed'
                            frameborder='0'
                            scrolling='yes'
                            src=''
                            width='350'
                            height='500'>
                    </iframe> -->
                </div>
            </div>

        </div>

    </body>
</html>
