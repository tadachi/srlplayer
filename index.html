<!DOCTYPE html>
<html lang='en'>
  <head>
	<meta content='text/html; charset=utf-8' http-equiv='content-type'>
	<title>TwitchPlayer</title>
	<link rel='stylesheet' href='css/main.css'>
	<!--<link rel='stylesheet' href='debug.css'>-->
	<!--<script src='js/debug.js'></script>-->
	<!-- <script src='js/jquery-2.0.3.min.js'></script> -->
	<!-- <script src='js/jquery-2.1.0.min.js'></script> -->
	<script src='js/jquery-2.1.1.min.js'></script>
	<script src='js/twitch.min.js'></script>

	<script>
		Twitch.init({clientId: '5wf6b3t4dqr0rfbthgkqqlz79yy9rg'}, function(error, status) {
		  if (error) {
			// error encountered while loading
			console.log(error);
		  }
		  // the sdk is now loaded
		  if (status.authenticated) {
			// user is currently logged in
		  }
		  console.log('Twitch API Initialized');
		});
		if (typeof jQuery != 'undefined') {  
			// jQuery is loaded => print the version
			console.log(jQuery.fn.jquery);
		}	
	</script>
	
	<script>
	if (!String.prototype.format) {
		String.prototype.format = function() {
			var str = this.toString();
			if (!arguments.length)
				return str;
			var args = typeof arguments[0],
				args = (('string' == args || 'number' == args) ? arguments : arguments[0]);
			for (arg in args)
				str = str.replace(RegExp('\\{' + arg + '\\}', 'gi'), args[arg]);
			return str;
		}
	}	
	
	function loadSrlTeamChannels() { //Check for Memory Leaks
		//'http://api.speedrunslive.com/test/team' 		<--- LIVE DATA
		//'test_srlJson.json' 							<--- TEST DATA
		$.getJSON('http://api.speedrunslive.com/test/team',function(json){
			srlTeamChannelTable(json);
		});

	}
	
	function srlTeamChannelTable(srlJson) { //Check for Memory Leaks

		if (srlJson) {
			try {
				for (var i = 0; i < 50; i++ ) {
					var txt = '';
					var list1 = '';
					var channel = srlJson.channels[i].channel;

					var image = '<img width=60 height=60 align=\'left\' src=\' ' +
						channel.image.size70 + '\' alt=min>';
					var list1 = '';
					
					if (i%2) { 
						list1 = '<li class=\'odd\' value={n}>'.format({n: i})
					} else {
						list1 = '<li class=\'even\' value={n}>'.format({n: i})
					}
					
					txt += '{opentag}{img1}{name} - {title}{endtag}'.format({
						opentag: list1,
						img1: image,					
						name: '<span style=\'font-size:140%\'>' + channel.display_name + '</span>',
						title: channel.title,
						endtag: '</li>'
						})

					if (txt != '') {
						$('#streams ul').append(txt).removeClass('hidden');
					}
				}
			} catch(err) { 
				console.log(err + ' (means there\'s no more streams to load)')
			}

			//This allows fast switching of streams by changing the param in the videoplayer object,
			$('#streams ul li').click( function() {
				data = $(this).text().split(' '); // data[0] or first item is the channel name. the rest of array not needed.

				// Create the channel string based on chosen stream.
				flashvars = 'channel={CHANNEL}&auto_play=true'.format({
					CHANNEL: data[0]});
	
				// Change the video channel via DOM			
				$('#videoplayer_embed param[name=flashvars]').attr('value', flashvars );
				
				// Reinject the videoplayer with the new params pointing to the chosen stream.
				reloadVideoPlayer();
				
				// Change the chat to the corresponding video channel.
				chatsrc = 'http://twitch.tv/chat/embed?channel={ch}&amp;popout_chat=true'.format({
					ch: data[0]});
					
				$('#chat_embed').attr('src', chatsrc); // this Faster does not work in IE.
				//reloadChatBox(chatsrc);
				
			});		
		}
	}
	
	function reloadVideoPlayer() { 
		player = $('#videoplayer');

		origin = player.html();

		player.html(origin);

	}
	
	function reloadChatBox(src) {
		res = calcResolutions();
	
		chatbox = $('#chatbox');
		origin = 	'<iframe ' +
						'id=\'chat_embed\' ' +
						'frameborder=\'0\' ' +
						'scrolling=\'yes\' ' +
						'src=\'{url}\' '.format({url: src}) +
						'width=\'{w}\' '.format({w: res.rightW}) +
						'height=\'{h}\'>'.format({h: res.rightH}) +
					'</iframe>';

		chatbox.html(origin);
	}
	
	/*
	* Creates and returns an object that has resolutions for 3 panels. left, center and right.
	*/
	function calcResolutions() {
		hOffset = 22; //Height for our header
		currWinWidth = $(window).width();
		currWinHeight = $(window).height();
		
		headerPanelWidth = Math.floor(currWinWidth);
		headerPanelHeight = Math.floor(hOffset);
		
		containerWidth = (currWinWidth);
		containerHeight = (currWinHeight);
		
		leftPanelWidth = Math.floor(0.12 * currWinWidth);
		leftPanelHeight = Math.floor(currWinHeight - hOffset);
		
		rightPanelWidth = Math.floor(0.18 * currWinWidth);
		rightPanelHeight = Math.floor(currWinHeight - hOffset);
		
		centerPanelWidth = Math.floor(0.70 * currWinWidth);
		centerPanelHeight = Math.floor(currWinHeight - hOffset);
		
		leftPlusCenterWidth = Math.floor(0.82 * currWinWidth);
		leftPlusCenterHeight = Math.floor(currWinHeight - hOffset);
		rightPlusCenterWidth = Math.ceil(0.88 * currWinWidth);
		rightPlusCenterHeight = Math.floor(currWinHeight - hOffset);
		centerOnlyWidth = Math.floor(currWinWidth);
		centerOnlyHeight = Math.floor(currWinHeight - hOffset);
		
		<!-- Debug -->
<!-- 		console.log('left: ' + leftPanelWidth + 'x' + leftPanelHeight); -->
<!-- 		console.log('right: ' + rightPanelWidth + 'x' + rightPanelHeight); -->
<!-- 		console.log('center: ' + centerPanelWidth + 'x' + centerPanelHeight); -->
<!-- 		console.log('leftCenter: ' + leftPlusCenterWidth + 'x' + leftPlusCenterHeight); -->
<!-- 		console.log('rightCenter: ' + rightPlusCenterWidth + 'x' + rightPlusCenterHeight); -->
<!-- 		console.log('centerOnly: ' + centerOnlyWidth + 'x' + centerOnlyHeight); -->
		<!-- End Debug -- >
		
		return {
				containerW: containerWidth, containerH: containerHeight,
				headerW: headerPanelWidth, headerH: headerPanelHeight,
				leftW: leftPanelWidth, leftH: leftPanelHeight,
				rightW: rightPanelWidth, rightH: rightPanelHeight,
				centerW: centerPanelWidth, centerH: centerPanelHeight,
				leftCenterW: leftPlusCenterWidth, leftCenterH: leftPlusCenterHeight,
				rightCenterW: rightPlusCenterWidth, rightCenterH: rightPlusCenterHeight,
				centerOnlyW: centerOnlyWidth, centerOnlyH: centerOnlyHeight
				};
				
	}
	
	function disableVerticalScrolling() {
		$('html, body').css({
			'overflow': 'hidden',
			'height': '100%'
		})	
	}

	function disableHorizontalScrolling() {
		$("html, body").css("overflow-x","hidden"); //hide horizontal scrollbar	
	}

	// Apply panel resolutions based on current window sizes to various divs
	function applyResolutions() {
		res = calcResolutions();
		
		$('#container').css('width', res.containerW);
		$('#container').css('height', res.containerH);
		
		$('#header').css('width',res.headerW);
		$('#header').css('height',res.headerH);

		$('#left ul').css('width', res.leftW);		
		$('#left ul li').css('width', res.leftW);

		if (leftShow) {
			$('#left').css('width', res.leftW);
			$('#left').css('height', res.leftH);		
		}
		if (rightShow) {
			$('#right').css('width', res.rightW);
			$('#right').css('height', res.rightH);		
		}
		if (!leftShow && rightShow) {
			$('#center').css('width', res.leftCenterW);
			$('#center').css('height', res.leftCenterH);			
			$('#videoplayer_embed').css('width', res.leftCenterW);
			$('#videoplayer_embed').css('height', res.leftCenterH);				
		}else if (leftShow && !rightShow) {
			$('#center').css('width', res.rightCenterW);
			$('#center').css('height', res.rightCenterH);	
			$('#videoplayer_embed').css('width', res.rightCenterW);
			$('#videoplayer_embed').css('height', res.rightCenterH);				
		}else if ( (!leftShow && !rightShow) ) {
			$('#center').css('width', res.centerOnlyW);
			$('#center').css('height', res.centerOnlyH);			
			$('#videoplayer_embed').css('width', res.centerOnlyW);
			$('#videoplayer_embed').css('height', res.centerOnlyH);		
		}else if (leftShow && !rightShow) {
			$('#center').css('width', res.rightCenterW);
			$('#center').css('height', res.rightCenterH);	
			$('#videoplayer_embed').css('width', res.rightCenterW);
			$('#videoplayer_embed').css('height', res.rightCenterH);				
		}else {
			console.log('test');
			$('#center').css('width', res.centerW);
			$('#center').css('height', res.centerH);
			$('#videoplayer_embed').css('width', res.centerW);
			$('#videoplayer_embed').css('height', res.centerH);		
		}
		
		$('#chat_embed').css('width', res.rightW);
		$('#chat_embed').css('height', res.rightH);
		$('#showhide_right').css('margin-left', res.headerW-49); //Hack to align image to far right properly
;
	
	}	

	function showHideLeft() {
		$('#left').toggle();
		leftShow = !leftShow;

		if (!leftShow && rightShow) {
			$('#center').css('width', res.leftCenterW);
			$('#center').css('height', res.leftCenterH);			
			$('#videoplayer_embed').css('width', res.leftCenterW);
			$('#videoplayer_embed').css('height', res.leftCenterH);				
		} 
		if ( (!leftShow && !rightShow) ) {
			$('#center').css('width', res.centerOnlyW);
			$('#center').css('height', res.centerOnlyH);			
			$('#videoplayer_embed').css('width', res.centerOnlyW);
			$('#videoplayer_embed').css('height', res.centerOnlyH);		
		}
		if (leftShow && !rightShow) {
			$('#center').css('width', res.rightCenterW);
			$('#center').css('height', res.rightCenterH);	
			$('#videoplayer_embed').css('width', res.rightCenterW);
			$('#videoplayer_embed').css('height', res.rightCenterH);				
		} 
		if ( leftShow && rightShow) {
			applyResolutions();
		}

	}
	
	function showHideRight() {
		$('#right').toggle();
		rightShow = !rightShow;
		
		if (leftShow && !rightShow) {
			$('#center').css('width', res.rightCenterW);
			$('#center').css('height', res.rightCenterH);	
			$('#videoplayer_embed').css('width', res.rightCenterW);
			$('#videoplayer_embed').css('height', res.rightCenterH);				
		} 
		if ( (!leftShow && !rightShow) ) {
			$('#center').css('width', res.centerOnlyW);
			$('#center').css('height', res.centerOnlyH);			
			$('#videoplayer_embed').css('width', res.centerOnlyW);
			$('#videoplayer_embed').css('height', res.centerOnlyH);		
		}
		if (!leftShow && rightShow) {
			$('#center').css('width', res.leftCenterW);
			$('#center').css('height', res.leftCenterH);			
			$('#videoplayer_embed').css('width', res.leftCenterW);
			$('#videoplayer_embed').css('height', res.leftCenterH);				
		} 
		if ( leftShow && rightShow) {
			applyResolutions();
		}

	}
	
	var leftShow = true;
	var rightShow = true;	
	
	$( document ).ready(function() {
		disableVerticalScrolling();
		disableHorizontalScrolling();
		
		loadSrlTeamChannels();
	
		applyResolutions();					// Apply panel resolutions based on current window sizes
		
		$('#showhide_left').click(function(event) {
			showHideLeft();
		});
		
		$('#showhide_right').click(function(event) {
			showHideRight();
		});
		
	});
	
	$( window ).resize(function() {
		applyResolutions();
	});

	</script>

	</head>
	<body>

		<div id='container'>

			<div id='header' class='hidden'>
				<!-- <div id='headerInfoDebug'></div> -->
				<img id='showhide_left' src='img/small_left_right_arrow.png' alt='min'>
				<img id='showhide_right' src='img/small_left_right_arrow.png' alt='min'>
			</div>
		
			<div id='left' class='panel hidden'>
<!--				<div id='leftInfoDebug'></div> -->
				<div id='streams'>
					<ul></ul>
				</div>		
			</div>

			<div id='center'>
<!-- 			<div id='centerInfoDebug'></div> -->
				<div id='videoplayer'>
					<object bgcolor='#000000' 
					data='http://www.twitch.tv/widgets/archive_embed_player.swf' 
					id='videoplayer_embed' 
					type='application/x-shockwave-flash' 
					width='800'
					height='600' >
					<param name='movie' value='http://www.twitch.tv/widgets/archive_embed_player.swf' />
					<param name='allowScriptAccess' value='always' />
					<param name='allowNetworking' value='all' />
					<param name='allowFullScreen' value='true' />
					<param name='flashvars' value='auto_play=false'/>
					</object>
				</div>
			</div>
			
			<div id='right' class='panel hidden'>
				<!-- <div id='rightInfoDebug'></div> -->
				<div id='chatbox'>
					<iframe id='chat_embed'
							frameborder='0'
							scrolling='yes'
							src=''
							width='350'
							height='500'>
					</iframe>
				</div>	
			</div>	
			
		</div>
	
	</body>
</html>